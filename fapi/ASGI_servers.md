# ASGI - сервер

## Uvicorn

***Установка***

Установи Uvicorn с помощью pip:  
> pip install uvicorn

Для установки с дополнительными зависимостями (например, для улучшенной производительности):  
>pip install 'uvicorn[standard]'

***Запуск приложения***  
Предположим, у тебя есть FastAPI-приложение в файле **app.py**:
```from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def read_root():
    return {"Hello": "World"}
```

Чтобы запустить приложение, используй команду:  
>uvicorn app:app --reload

Здесь **app:app** указывает на файл и экземпляр приложения, а   
**--reload** включает автоматическую перезагрузку при изменении кода (удобно для разработки).  

**Дополнительные параметры**  
**Количество рабочих процессов:** можно указать количество рабочих процессов (workers) для обработки запросов:
>uvicorn app:app --workers 4

**HTTP/2 и WebSockets:** можно добавить поддержку HTTP/2:
>uvicorn app:app --http2


## Hypercorn  

***Установка***

Установи Hypercorn с помощью pip:  
> pip install hypercorn

***Запуск приложения***

Запуск FastAPI-приложения с помощью Hypercorn аналогичен:  
>hypercorn app:app

**Дополнительные возможности**  
**Количество рабочих процессов:** аналогично Uvicorn, Hypercorn поддерживает запуск нескольких процессов:  
>hypercorn app:app --workers 4

**HTTP/2 и WebSockets:** Hypercorn поддерживает HTTP/2, его можно включить флагом:  
>hypercorn app:app --http2

**Конфигурация через файл:** можно создать файл конфигурации (например, **hypercorn.toml**), 
чтобы указать параметры, что упрощает запуск:  

```[bind]
address = "0.0.0.0:8000"

[workers]
count = 4

[http]
http2 = true
```
Затем просто запусти:  
> hypercorn -c hypercorn.toml app:app

***Подробнее о hypercorn.toml***

Файл конфигурации hypercorn.toml позволяет настраивать параметры работы Hypercorn в удобном формате. Этот файл используется для хранения различных опций, таких как параметры привязки, количество рабочих процессов, поддержка HTTP/2 и другие настройки. Вот основные параметры, которые можно указать в hypercorn.toml:
Пример структуры файла
```[bind]
address = "0.0.0.0:8000"  # Адрес и порт, на которых будет запущен сервер.

[workers]
count = 4  # Количество рабочих процессов.

[http]
http2 = true  # Включить поддержку HTTP/2.
```

**Параметры конфигурации**

1. [bind]

    address: Адрес и порт, на которых сервер будет слушать входящие соединения. Например, "0.0.0.0:8000" для прослушивания на всех интерфейсах и порту 8000.

2. [workers]

    count: Количество рабочих процессов (workers), которые будут запущены. Это помогает масштабировать приложение и позволяет обрабатывать больше запросов одновременно. Рекомендуется устанавливать количество рабочих процессов в зависимости от количества доступных CPU.

3. [http]

    http2: Логическое значение (true или false), указывающее, поддерживает ли сервер HTTP/2. Если включено, сервер будет обрабатывать запросы по этому протоколу.

4. [websockets]

    Можно также включить поддержку WebSockets (по умолчанию включена):  
```[websockets]
enabled = true
```

5. [timeout]

   Можно указать таймауты для соединений:  
```[timeout]
request = 60  # Таймаут для обработки запроса в секундах.
```

***Запуск сервера с конфигурацией***  
После создания файла **hypercorn.toml** его можно использовать для запуска сервера с помощью следующей команды:  
>hypercorn -c hypercorn.toml app:app

Структура команды  
**hypercorn**: это команда для запуска ASGI-сервера Hypercorn.  
**-c hypercorn.toml** : этот флаг указывает Hypercorn использовать файл конфигурации hypercorn.toml. 
Этот файл содержит настройки, такие как адрес, порт, количество рабочих процессов и другие параметры, которые определяют, как будет работать сервер.   
**app:app** : здесь указывается путь к приложению. Первая часть (до двоеточия) — это имя файла (без .py), 
а вторая часть — это экземпляр приложения FastAPI или Starlette. 
Например, если у тебя есть файл app.py с экземпляром приложения 
app, эта часть указывает на него.

***Пример полного файла***
```[bind]
address = "0.0.0.0:8000"

[workers]
count = 4

[http]
http2 = true

[websockets]
enabled = true

[timeout]
request = 60
```

Для продакшена часто используют **Nginx** в качестве обратного прокси для управления трафиком и балансировки нагрузки:

Nginx принимает HTTP/HTTPS-запросы и перенаправляет их на Hypercorn.
    Пример конфигурации Nginx для FastAPI:


```
server {
    listen 80;
    server_name example.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

```
---
[вернуться к Fastapi](readme_fastapi.md)


